<!-- Editor.md Styles -->
<link rel="stylesheet" href="/editor.md/css/editormd.min.css" />

<style>
.dropdown-menu.searchable { min-width: 280px; max-width: 100%; padding: 0.5rem; }
.dropdown-item-selectable { padding: .25rem .5rem; cursor: pointer; border-radius: .25rem; }
.dropdown-item-selectable:hover { background-color: #f8f9fa; }
.dropdown-item-selectable.active { background-color: #0d6efd; color: white; }
.no-results { padding: .5rem .75rem; color: #6c757d; }
.search-input { margin-bottom: .5rem; }
.item-list { max-height: 240px; overflow: auto; }
</style>

<div class="container-xl">
    {{if .Error}}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        {{.Error}}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {{end}}

    <div class="row mb-3">
        <div class="col-lg-5">
            <div class="input-group shadow-sm">
                <input id="alternative-input" name="alternative-input" type="text" class="form-control form-control-lg border-end-0" placeholder="{{.Dictionary.Editor.AlternativePlaceholder}}" value="{{.Dto.Post.Path}}">
            </div>
        </div>
        <div class="col-lg-4">
            <div class="input-group shadow-sm">
                <form id="image-form" name="image-form" method="post" enctype='multipart/form-data' class="w-100">
                    <input id="image-input" name="image-input" type="file" class="form-control form-control-lg border-end-0" accept="image/*">
                </form>
            </div>
        </div>
        <div class="col-lg-3">
            <a href="{{.Dto.Post.Image}}" data-lightbox="image-{{.Dto.Post.Id}}" data-title="{{.Dto.Post.Title}}">
                <img src="{{.Dto.Post.Image}}" alt="{{.Dto.Post.Title}}" class="img-fluid rounded-start w-100 object-fit-cover" style="max-height: 200px; object-fit: cover; height: 50px;">
            </a>
        </div>
    </div>

    <!-- Editor Header -->
    <div class="row mb-4">
        <div class="col-lg-3">
            <div class="dropdown">
                <button id="ddButton" class="btn btn-outline-secondary dropdown-toggle px-4" type="button" data-bs-toggle="dropdown" aria-expanded="false" style="width: 100%; height: 100%;">
                    Tags <span id="selectedCount" class="badge bg-primary ms-2">0</span>
                </button>

                <div class="dropdown-menu p-2 searchable" aria-labelledby="ddButton" style="width: 100%;">
                    <div class="search-input">
                        <input id="ddSearch" class="form-control form-control-sm" type="search" placeholder="Search..." aria-label="Search options">
                    </div>

                    <div id="itemList" class="item-list">
                        {{range .Dto.Tags}}
                        <div class="dropdown-item-selectable {{if .Selected}}active{{end}}" data-value="{{.Tag.Name}}" id="{{.Tag.Id}}">
                            {{.Tag.Name}}
                            <span class="badge rounded-pill ms-2 pull-right" style="background-color: {{.Tag.Color}};"> </span>
                        </div>
                        {{end}}
                    </div>

                    <div id="noResults" class="no-results d-none">No results</div>

                    <div class="mt-2 d-flex justify-content-between">
                        <div class="input-group shadow-sm">
                            <input id="tag-title" type="text" class="form-control form-control-sm border-end-0" placeholder="Tag">
                            <button id="save-tag-btn" class="btn btn-outline-secondary" type="button">+</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-9">
            <div class="input-group shadow-sm">
                <input id="title" type="text" class="form-control form-control-lg border-end-0" placeholder="{{.Dictionary.Editor.TitlePlaceholder}}" value="{{.Dto.Post.Title}}">
                <button id="save-btn" class="btn btn-outline-success px-4" type="button">
                    ðŸ’¾ {{.Dictionary.Editor.BtnSave}}
                </button>
            </div>
        </div>
    </div>

    <!-- Editor Markdown Area -->
    <div id="editor">
        <!-- Editor.md will inject the textarea here -->
        <textarea style="display:none;">{{.Dto.Post.Markdown}}</textarea>
    </div>

</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="/editor.md/editormd.min.js"></script>
<script src="/editor.js"></script>
<script type="text/javascript">
    var editor
    $(function() {
        editor = editormd("editor", {
            width: "100%",
            height: "1000px",
            delay: 10,
            // markdown: "xxxx",     // dynamic set Markdown text
            path : "/editor.md/lib/",  // Autoload modules mode, codemirror, marked... dependents libs path
            // theme : "dark",
            // previewTheme : "dark",
            // editorTheme : "pastel-on-dark",
            codeFold : true,
            // syncScrolling : false,
            saveHTMLToTextarea : true,    // ä¿å­˜ HTML åˆ° Textarea
            searchReplace : true,
            // watch : false,                // å…³é—­å®žæ—¶é¢„è§ˆ
            htmlDecode : "style,script,iframe|on*",            // å¼€å¯ HTML æ ‡ç­¾è§£æžï¼Œä¸ºäº†å®‰å…¨æ€§ï¼Œé»˜è®¤ä¸å¼€å¯
            // toolbar  : false,             //å…³é—­å·¥å…·æ 
            // previewCodeHighlight : false, // å…³é—­é¢„è§ˆ HTML çš„ä»£ç å—é«˜äº®ï¼Œé»˜è®¤å¼€å¯
            emoji : true,
            taskList : true,
            tocm            : true,         // Using [TOCM]
            tex : true,                   // å¼€å¯ç§‘å­¦å…¬å¼TeXè¯­è¨€æ”¯æŒï¼Œé»˜è®¤å…³é—­
            // flowChart : true,             // å¼€å¯æµç¨‹å›¾æ”¯æŒï¼Œé»˜è®¤å…³é—­
            // sequenceDiagram : true,       // å¼€å¯æ—¶åº/åºåˆ—å›¾æ”¯æŒï¼Œé»˜è®¤å…³é—­,
            // dialogLockScreen : false,   // è®¾ç½®å¼¹å‡ºå±‚å¯¹è¯æ¡†ä¸é”å±ï¼Œå…¨å±€é€šç”¨ï¼Œé»˜è®¤ä¸ºtrue
            // dialogShowMask : false,     // è®¾ç½®å¼¹å‡ºå±‚å¯¹è¯æ¡†æ˜¾ç¤ºé€æ˜Žé®ç½©å±‚ï¼Œå…¨å±€é€šç”¨ï¼Œé»˜è®¤ä¸ºtrue
            // dialogDraggable : false,    // è®¾ç½®å¼¹å‡ºå±‚å¯¹è¯æ¡†ä¸å¯æ‹–åŠ¨ï¼Œå…¨å±€é€šç”¨ï¼Œé»˜è®¤ä¸ºtrue
            // dialogMaskOpacity : 0.4,    // è®¾ç½®é€æ˜Žé®ç½©å±‚çš„é€æ˜Žåº¦ï¼Œå…¨å±€é€šç”¨ï¼Œé»˜è®¤å€¼ä¸º0.1
            // dialogMaskBgColor : "#000", // è®¾ç½®é€æ˜Žé®ç½©å±‚çš„èƒŒæ™¯é¢œè‰²ï¼Œå…¨å±€é€šç”¨ï¼Œé»˜è®¤ä¸º#fff
            imageUpload : true,
            imageFormats : ["jpg", "jpeg", "gif", "png", "bmp", "webp"],
            imageUploadURL : "/api/post/image",
            onload : function() {
                console.log('onload', this);
                //this.fullscreen();
                //this.unwatch();
                //this.watch().fullscreen();

                //this.setMarkdown("#PHP");
                //this.width("100%");
                //this.height(480);
                //this.resize("100%", 640);
            },
            lang : {
                name : "en",
                description                     : "{{.Dictionary.Editor.Description}}",
                tocTitle                        : "{{.Dictionary.Editor.TocTitle}}",
                toolbar : {
                    undo                        : "{{.Dictionary.Editor.ToolbarUndo}}",
                    redo                        : "{{.Dictionary.Editor.ToolbarRedo}}",
                    bold                        : "{{.Dictionary.Editor.ToolbarBold}}",
                    del                         : "{{.Dictionary.Editor.ToolbarDel}}",
                    italic                      : "{{.Dictionary.Editor.ToolbarItalic}}",
                    quote                       : "{{.Dictionary.Editor.ToolbarQuote}}",
                    ucwords                     : "{{.Dictionary.Editor.ToolbarUcwords}}",
                    uppercase                   : "{{.Dictionary.Editor.ToolbarUppercase}}",
                    lowercase                   : "{{.Dictionary.Editor.ToolbarLowercase}}",
                    h1                          : "{{.Dictionary.Editor.ToolbarH1}}",
                    h2                          : "{{.Dictionary.Editor.ToolbarH2}}",
                    h3                          : "{{.Dictionary.Editor.ToolbarH3}}",
                    h4                          : "{{.Dictionary.Editor.ToolbarH4}}",
                    h5                          : "{{.Dictionary.Editor.ToolbarH5}}",
                    h6                          : "{{.Dictionary.Editor.ToolbarH6}}",
                    "list-ul"                   : "{{.Dictionary.Editor.ToolbarListUl}}",
                    "list-ol"                   : "{{.Dictionary.Editor.ToolbarListOl}}",
                    hr                          : "{{.Dictionary.Editor.ToolbarHr}}",
                    link                        : "{{.Dictionary.Editor.ToolbarLink}}",
                    "reference-link"            : "{{.Dictionary.Editor.ToolbarReferenceLink}}",
                    image                       : "{{.Dictionary.Editor.ToolbarImage}}",
                    code                        : "{{.Dictionary.Editor.ToolbarCode}}",
                    "preformatted-text"         : "{{.Dictionary.Editor.ToolbarPreformattedText}}",
                    "code-block"                : "{{.Dictionary.Editor.ToolbarCodeBlock}}",
                    table                       : "{{.Dictionary.Editor.ToolbarTable}}",
                    datetime                    : "{{.Dictionary.Editor.ToolbarDatetime}}",
                    emoji                       : "{{.Dictionary.Editor.ToolbarEmoji}}",
                    "html-entities"             : "{{.Dictionary.Editor.ToolbarHtmlEntities}}",
                    pagebreak                   : "{{.Dictionary.Editor.ToolbarPagebreak}}",
                    watch                       : "{{.Dictionary.Editor.ToolbarWatch}}",
                    unwatch                     : "{{.Dictionary.Editor.ToolbarUnwatch}}",
                    preview                     : "{{.Dictionary.Editor.ToolbarPreview}}",
                    fullscreen                  : "{{.Dictionary.Editor.ToolbarFullscreen}}",
                    clear                       : "{{.Dictionary.Editor.ToolbarClear}}",
                    search                      : "{{.Dictionary.Editor.ToolbarSearch}}",
                    help                        : "{{.Dictionary.Editor.ToolbarHelp}}",
                    info                        : "{{.Dictionary.Editor.ToolbarInfo}}",
                },
                buttons : {
                    enter                       : "{{.Dictionary.Editor.ButtonsEnter}}",
                    cancel                      : "{{.Dictionary.Editor.ButtonsCancel}}",
                    close                       : "{{.Dictionary.Editor.ButtonsClose}}",
                },
                dialog : {
                    link : {
                        title                   : "{{.Dictionary.Editor.DialogLinkTitle}}",
                        url                     : "{{.Dictionary.Editor.DialogLinkUrl}}",
                        urlTitle                : "{{.Dictionary.Editor.DialogLinkUrlTitle}}",
                        urlEmpty                : "{{.Dictionary.Editor.DialogLinkUrlEmpty}}",
                    },
                    referenceLink : {
                        title                   : "{{.Dictionary.Editor.DialogReferenceLinkTitle}}",
                        name                    : "{{.Dictionary.Editor.DialogReferenceLinkName}}",
                        url                     : "{{.Dictionary.Editor.DialogReferenceLinkUrl}}",
                        urlId                   : "{{.Dictionary.Editor.DialogReferenceLinkUrlId}}",
                        urlTitle                : "{{.Dictionary.Editor.DialogReferenceLinkUrlTitle}}",
                        nameEmpty               : "{{.Dictionary.Editor.DialogReferenceLinkNameEmpty}}",
                        idEmpty                 : "{{.Dictionary.Editor.DialogReferenceLinkIdEmpty}}",
                        urlEmpty                : "{{.Dictionary.Editor.DialogReferenceLinkUrlEmpty}}",
                    },
                    image : {
                        title                   : "{{.Dictionary.Editor.DialogImageTitle}}",
                        url                     : "{{.Dictionary.Editor.DialogImageUrl}}",
                        link                    : "{{.Dictionary.Editor.DialogImageLink}}",
                        alt                     : "{{.Dictionary.Editor.DialogImageAlt}}",
                        uploadButton            : "{{.Dictionary.Editor.DialogImageUploadButton}}",
                        imageURLEmpty           : "{{.Dictionary.Editor.DialogImageImageURLEmpty}}",
                        uploadFileEmpty         : "{{.Dictionary.Editor.DialogImageUploadFileEmpty}}",
                        formatNotAllowed        : "{{.Dictionary.Editor.DialogImageFormatNotAllowed}}",
                    },
                    preformattedText : {
                        title                   : "{{.Dictionary.Editor.DialogPreformattedTextTitle}}",
                        emptyAlert              : "{{.Dictionary.Editor.DialogPreformattedTextEmptyAlert}}",
                        placeholder             : "{{.Dictionary.Editor.DialogPreformattedTextPlaceholder}}",
                    },
                    codeBlock : {
                        title                   : "{{.Dictionary.Editor.DialogCodeBlockTitle}}",
                        selectLabel             : "{{.Dictionary.Editor.DialogCodeBlockSelectLabel}}",
                        selectDefaultText       : "{{.Dictionary.Editor.DialogCodeBlockSelectDefaultText}}",
                        otherLanguage           : "{{.Dictionary.Editor.DialogCodeBlockOtherLanguage}}",
                        unselectedLanguageAlert : "{{.Dictionary.Editor.DialogCodeBlockUnselectedLanguageAlert}}",
                        codeEmptyAlert          : "{{.Dictionary.Editor.DialogCodeBlockCodeEmptyAlert}}",
                        placeholder             : "{{.Dictionary.Editor.DialogCodeBlockPlaceholder}}",
                    },
                    htmlEntities : {
                        title                   : "{{.Dictionary.Editor.DialogHtmlEntitiesTitle}}",
                    },
                    help : {
                        title                   : "{{.Dictionary.Editor.DialogHelpTitle}}",
                    }
                }
            }
        });

        document.getElementById('save-btn').onclick = function() {
            title = document.getElementById('title').value
            alter = document.getElementById('alternative-input').value

            tags = Array.from(itemList.querySelectorAll('.dropdown-item-selectable')).filter(it => it.classList.contains('active')).map(it => it.id);

            save_post('{{.Dto.Post.Id}}', title, editor.getMarkdown(), editor.getHTML(), alter, tags);
            document.location.href = "/"
        }

        document.getElementById('save-tag-btn').onclick = function() {
            tag_name = document.getElementById('tag-title')
            fetch_with_json('/tag/add', {name: tag_name.value}, (tag) => {
                if (typeof(tag) === 'string') return
                itemList = document.getElementById('itemList')
                itemList.innerHTML += `<div id="dropdown-`+tag.Name+`" class="dropdown-item-selectable" data-value="`+tag.name+`" id="`+tag.id+`">
                    `+tag.name+`
                    <span class="badge rounded-pill ms-2 pull-right" style="background-color: `+tag.color+`;"> </span>
                </div>`

                newTag = document.getElementById('dropdown-'+tag.Name)
                newTag.click()
                tag_name.value = ''
            })
        }

        document.getElementById('image-input').onchange = function() {
            document.getElementById('save-btn').click()
            this.parentElement.submit()
        }
    });
</script>

<!-- Lightbox2 CSS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.4/css/lightbox.min.css" rel="stylesheet" />

<!-- Lightbox2 JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.4/js/lightbox.min.js"></script>


<script>
    (function(){
        const ddSearch = document.getElementById('ddSearch');
        const itemList = document.getElementById('itemList');
        const items = () => Array.from(itemList.querySelectorAll('.dropdown-item-selectable'));
        const selectedCount = document.getElementById('selectedCount');
        const noResults = document.getElementById('noResults');
        // const clearBtn = document.getElementById('clearBtn');
        const ddButton = document.getElementById('ddButton');


        function updateSelectedCount() {
            const count = items().filter(it => it.classList.contains('active')).length;
            selectedCount.textContent = count;
        }

        function filterList() {
            const q = ddSearch.value.trim().toLowerCase();
            let visible = 0;
            items().forEach(item => {
                const label = item.textContent.toLowerCase();
                if (!q || label.includes(q)) {
                    item.classList.remove('d-none');
                    visible++;
                } else {
                    item.classList.add('d-none');
                }
            });
            noResults.classList.toggle('d-none', visible !== 0);
        }

        itemList.addEventListener('click', (e) => {
            const item = e.target.closest('.dropdown-item-selectable');
            if (!item) return;
            item.classList.toggle('active');
            updateSelectedCount();
            const chosen = items().filter(it => it.classList.contains('active')).map(it => it.dataset.value);
            ddButton.innerHTML = chosen.length ? (chosen.join(', ') + ` <span id="selectedCount" class="badge bg-primary ms-2">${chosen.length}</span>`) : 'Select items <span id="selectedCount" class="badge bg-primary ms-2">0</span>';
        });

        ddSearch.addEventListener('input', filterList);

        // clearBtn.addEventListener('click', () => {
        //     items().forEach(it => it.classList.remove('active'));
        //     updateSelectedCount();
        // });

        updateSelectedCount();
        filterList();
        const chosen = items().filter(it => it.classList.contains('active')).map(it => it.dataset.value);
        ddButton.innerHTML = chosen.length ? (chosen.join(', ') + ` <span id="selectedCount" class="badge bg-primary ms-2">${chosen.length}</span>`) : 'Select items <span id="selectedCount" class="badge bg-primary ms-2">0</span>';
    })();
</script>
